**Локальное поднятие сервисов - docker compose**
=====================================

Для поднятия проекта необходимо:

Перенести папку `setup_docker` в родительскую папку, где располагаются другие сервисы.
Далее выполнить bash скрипт:
```
sh docker_setup.sh
```
Далее необходимо поднять контейнеры:
```bash
sh up_docker.sh --keycloak-auth --up-all
```

  Опции запуска:
- `--keycloak-auth` — использовать `KeyCloak` авторизацию для `backend_proxy`, по умолчанию будет использовать `FAKE` авторизация;
- `--up-all` — поднимает все доступные сервисы, без нее будет предложено интерактивно в консоли выбрать необходимые сервисы.


**Авторизация с KeyCloak**
=====================================

При запуске сервисов с ключом `--keycloak-auth` будет поднят контейнер с `KeyCloak` и отдельная база данных, 
так же сервис локального хоста между `KeyCloak` и сервисом `backend_proxy`

Для авторизации с `KeyCloak` можно использовать ручку:
```
http://localhost:8006/keycloak_login
```

При старте сервисов доступы следующие пользователи:
- `username`: fs_admin, `password`: 1234567890, `groups`: FS_Admins
- `username`: multigroup, `password`: 1234567890, `groups`: FS_Chief_Data_Engineers, FS_Chief_Data_Scientists, и.т.д. за исключением админской

При необходимости пользователя с иными группами можно добавть в файле `./docker_composes/keycloak/realm-export.json` по аналогии с уже созданными пользователями

**Конфигурация сервисов**
=====================================

Для успешного поднятия всех сервисов необходимо склонировать их на локальную машину и расположить их в одном каталоге.
Названия папок должны совпадать с названиями репозиториев на BitBucket.

При создании контейнера с postgres создаются схемы:
- `stable_general`
- `stable_registry`
- `mm_stable`
- `stable_users`
- `stable_model_manager`
- `public`
------
При поднятии контейнеров производится создание и заполнение необходимых таблиц.
Если у вас установленно виртуальное окружение (venv) вы можете использовать ручной upgrade/downgrade БД:

```
./upgrade_db.sh
./downgrade_db.sh
```
Если какие-то данные не нужны для добавления/удаления следует закомментировать соотвествующую строчку кода.

Если необходимо сделать upgrade/downgrade ДБ, но вы хотите использовать исключительно docker, следует войти в fs_db контейнер, перейти в каталог
docker_db и выполнить там соответствующие операции.
Список доступных команд:
```
./downgrade_db.sh - очистка всей базы данных

./ug_{registry}/{users}/{models}/{metrics}/{general} - частичное добавление

./dg_{registry}/{users}/{models}/{metrics}/{general} - частичное удаление

Пример: ./ug_registry.sh
```
Если что-то пошло не так, вы всегда можете удалить pg контейнер! При повторной установке все придет в норму.

----
Для подключения к БД в контейнере и выбора схемы использовать:
```
psql -U postgres -d fs_metastore;
SET search_path TO ИМЯ СХЕМЫ;
```
------
Если необходимо установить fs_db и fs_common_lib, используя локальные версии библиотек, необходимо указать в my_arg сервиса значение 2.
Значение 1 устанавливается в случае дефолтной установки зависимостей из alfa registry.
Пример:
```
  model_manager:
    build:
      context: ../
      dockerfile: test_docker/fs_model_manager/Dockerfile
      args:
        my_arg: 2
```
